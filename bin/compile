#!/usr/bin/env bash

# Usage: bin/compile BUILD_DIR CACHE_DIR ENV_DIR

set -euo pipefail

# Detect requirements and fail if not met.
# Note: we can't do this in bin/detect script
# as we don't have access to env vars there.

build_dir=$1
env_dir=$3

failed=false
for env_var in FRONTEND_BUILDPACK_JS_APP FRONTEND_BUILDPACK_JS_ROUTE FRONTEND_BUILDPACK_RAILS_APP; do
  if [[ -f "${env_dir}/${env_var}" ]]; then
    export ${env_var}="$(cat ${env_dir}/${env_var})"
  else
    echo "FATAL: Please set env var: ${env_var}"
    failed=true
  fi
done

if [ $failed = true ]; then
  exit 1
fi

rails_app="${build_dir}/${FRONTEND_BUILDPACK_RAILS_APP}"
js_route="${FRONTEND_BUILDPACK_JS_ROUTE}"
frontends_raw="${rails_app}/frontends/raw"
js_app_raw="${frontends_raw}/${js_route}"
# fail if not exist ^^^

js_app_requirement=$js_app_raw/package.json
if [[ ! -f ${js_app_requirement} ]]; then
  echo "FATAL: Missing expected file: ${js_app_requirement}"
  failed=true
fi

frontend="${rails_app}/frontends/${js_route}"
if [[ -e $frontend ]]; then
  echo "FATAL: Unexpected: $frontend already exists"
  failed=true
fi

static="${rails_app}/public/${js_route}/static"
if [[ -e $static ]]; then
  echo "FATAL: Unexpected: $static already exists"
  failed=true
fi

if [ $failed = true ]; then
  exit 1
fi

# Requirements are met; proceed with main actions:

set -x
cd ${frontends_raw}
ln -sf ${rails_app} ${FRONTEND_BUILDPACK_RAILS_APP}

echo "-----> Building JS app"
set -x
cd ${js_app_raw}
yarn install --frozen-lockfile --production
yarn build

set +x
echo "-----> Copying index.html to frontend dir"
set -x
mkdir -p ${frontend}
cp ${js_app_raw}/build/index.html ${frontend}/

ls -laFG ${frontend}/

set +x
echo "-----> Copying static dir to rails public dir"
set -x
mkdir -p ${static}
cp -r ${js_app_raw}/build/static/. ${static}

ls -laFG ${static}/
